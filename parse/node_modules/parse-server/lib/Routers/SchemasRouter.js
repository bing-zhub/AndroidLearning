'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.SchemasRouter = undefined;

var _PromiseRouter = require('../PromiseRouter');

var _PromiseRouter2 = _interopRequireDefault(_PromiseRouter);

var _middlewares = require('../middlewares');

var middleware = _interopRequireWildcard(_middlewares);

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

// schemas.js

var Parse = require('parse/node').Parse,
    SchemaController = require('../Controllers/SchemaController');

function classNameMismatchResponse(bodyClass, pathClass) {
  throw new Parse.Error(Parse.Error.INVALID_CLASS_NAME, `Class name mismatch between ${bodyClass} and ${pathClass}.`);
}

function getAllSchemas(req) {
  return req.config.database.loadSchema({ clearCache: true }).then(schemaController => schemaController.getAllClasses(true)).then(schemas => ({ response: { results: schemas } }));
}

function getOneSchema(req) {
  const className = req.params.className;
  return req.config.database.loadSchema({ clearCache: true }).then(schemaController => schemaController.getOneSchema(className, true)).then(schema => ({ response: schema })).catch(error => {
    if (error === undefined) {
      throw new Parse.Error(Parse.Error.INVALID_CLASS_NAME, `Class ${className} does not exist.`);
    } else {
      throw new Parse.Error(Parse.Error.INTERNAL_SERVER_ERROR, 'Database adapter error.');
    }
  });
}

function createSchema(req) {
  if (req.auth.isReadOnly) {
    throw new Parse.Error(Parse.Error.OPERATION_FORBIDDEN, 'read-only masterKey isn\'t allowed to create a schema.');
  }
  if (req.params.className && req.body.className) {
    if (req.params.className != req.body.className) {
      return classNameMismatchResponse(req.body.className, req.params.className);
    }
  }

  const className = req.params.className || req.body.className;
  if (!className) {
    throw new Parse.Error(135, `POST ${req.path} needs a class name.`);
  }

  return req.config.database.loadSchema({ clearCache: true }).then(schema => schema.addClassIfNotExists(className, req.body.fields, req.body.classLevelPermissions, req.body.indexes)).then(schema => ({ response: schema }));
}

function modifySchema(req) {
  if (req.auth.isReadOnly) {
    throw new Parse.Error(Parse.Error.OPERATION_FORBIDDEN, 'read-only masterKey isn\'t allowed to update a schema.');
  }
  if (req.body.className && req.body.className != req.params.className) {
    return classNameMismatchResponse(req.body.className, req.params.className);
  }

  const submittedFields = req.body.fields || {};
  const className = req.params.className;

  return req.config.database.loadSchema({ clearCache: true }).then(schema => schema.updateClass(className, submittedFields, req.body.classLevelPermissions, req.body.indexes, req.config.database)).then(result => ({ response: result }));
}

const deleteSchema = req => {
  if (req.auth.isReadOnly) {
    throw new Parse.Error(Parse.Error.OPERATION_FORBIDDEN, 'read-only masterKey isn\'t allowed to delete a schema.');
  }
  if (!SchemaController.classNameIsValid(req.params.className)) {
    throw new Parse.Error(Parse.Error.INVALID_CLASS_NAME, SchemaController.invalidClassNameMessage(req.params.className));
  }
  return req.config.database.deleteSchema(req.params.className).then(() => ({ response: {} }));
};

class SchemasRouter extends _PromiseRouter2.default {
  mountRoutes() {
    this.route('GET', '/schemas', middleware.promiseEnforceMasterKeyAccess, getAllSchemas);
    this.route('GET', '/schemas/:className', middleware.promiseEnforceMasterKeyAccess, getOneSchema);
    this.route('POST', '/schemas', middleware.promiseEnforceMasterKeyAccess, createSchema);
    this.route('POST', '/schemas/:className', middleware.promiseEnforceMasterKeyAccess, createSchema);
    this.route('PUT', '/schemas/:className', middleware.promiseEnforceMasterKeyAccess, modifySchema);
    this.route('DELETE', '/schemas/:className', middleware.promiseEnforceMasterKeyAccess, deleteSchema);
  }
}
exports.SchemasRouter = SchemasRouter;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9Sb3V0ZXJzL1NjaGVtYXNSb3V0ZXIuanMiXSwibmFtZXMiOlsibWlkZGxld2FyZSIsIlBhcnNlIiwicmVxdWlyZSIsIlNjaGVtYUNvbnRyb2xsZXIiLCJjbGFzc05hbWVNaXNtYXRjaFJlc3BvbnNlIiwiYm9keUNsYXNzIiwicGF0aENsYXNzIiwiRXJyb3IiLCJJTlZBTElEX0NMQVNTX05BTUUiLCJnZXRBbGxTY2hlbWFzIiwicmVxIiwiY29uZmlnIiwiZGF0YWJhc2UiLCJsb2FkU2NoZW1hIiwiY2xlYXJDYWNoZSIsInRoZW4iLCJzY2hlbWFDb250cm9sbGVyIiwiZ2V0QWxsQ2xhc3NlcyIsInNjaGVtYXMiLCJyZXNwb25zZSIsInJlc3VsdHMiLCJnZXRPbmVTY2hlbWEiLCJjbGFzc05hbWUiLCJwYXJhbXMiLCJzY2hlbWEiLCJjYXRjaCIsImVycm9yIiwidW5kZWZpbmVkIiwiSU5URVJOQUxfU0VSVkVSX0VSUk9SIiwiY3JlYXRlU2NoZW1hIiwiYXV0aCIsImlzUmVhZE9ubHkiLCJPUEVSQVRJT05fRk9SQklEREVOIiwiYm9keSIsInBhdGgiLCJhZGRDbGFzc0lmTm90RXhpc3RzIiwiZmllbGRzIiwiY2xhc3NMZXZlbFBlcm1pc3Npb25zIiwiaW5kZXhlcyIsIm1vZGlmeVNjaGVtYSIsInN1Ym1pdHRlZEZpZWxkcyIsInVwZGF0ZUNsYXNzIiwicmVzdWx0IiwiZGVsZXRlU2NoZW1hIiwiY2xhc3NOYW1lSXNWYWxpZCIsImludmFsaWRDbGFzc05hbWVNZXNzYWdlIiwiU2NoZW1hc1JvdXRlciIsIlByb21pc2VSb3V0ZXIiLCJtb3VudFJvdXRlcyIsInJvdXRlIiwicHJvbWlzZUVuZm9yY2VNYXN0ZXJLZXlBY2Nlc3MiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFLQTs7OztBQUNBOztJQUFZQSxVOzs7Ozs7QUFOWjs7QUFFQSxJQUFJQyxRQUFRQyxRQUFRLFlBQVIsRUFBc0JELEtBQWxDO0FBQUEsSUFDRUUsbUJBQW1CRCxRQUFRLGlDQUFS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WyIvLyBzY2hlbWFzLmpzXG5cbnZhciBQYXJzZSA9IHJlcXVpcmUoJ3BhcnNlL25vZGUnKS5QYXJzZSxcbiAgU2NoZW1hQ29udHJvbGxlciA9IHJlcXVpcmUoJy4uL0NvbnRyb2xsZXJzL1NjaGVtYUNvbnRyb2xsZXInKTtcblxuaW1wb3J0IFByb21pc2VSb3V0ZXIgICBmcm9tICcuLi9Qcm9taXNlUm91dGVyJztcbmltcG9ydCAqIGFzIG1pZGRsZXdhcmUgZnJvbSBcIi4uL21pZGRsZXdhcmVzXCI7XG5cbmZ1bmN0aW9uIGNsYXNzTmFtZU1pc21hdGNoUmVzcG9uc2UoYm9keUNsYXNzLCBwYXRoQ2xhc3MpIHtcbiAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFxuICAgIFBhcnNlLkVycm9yLklOVkFMSURfQ0xBU1NfTkFNRSxcbiAgICBgQ2xhc3MgbmFtZSBtaXNtYXRjaCBiZXR3ZWVuICR7Ym9keUNsYXNzfSBhbmQgJHtwYXRoQ2xhc3N9LmBcbiAgKTtcbn1cblxuZnVuY3Rpb24gZ2V0QWxsU2NoZW1hcyhyZXEpIHtcbiAgcmV0dXJuIHJlcS5jb25maWcuZGF0YWJhc2UubG9hZFNjaGVtYSh7IGNsZWFyQ2FjaGU6IHRydWV9KVxuICAgIC50aGVuKHNjaGVtYUNvbnRyb2xsZXIgPT4gc2NoZW1hQ29udHJvbGxlci5nZXRBbGxDbGFzc2VzKHRydWUpKVxuICAgIC50aGVuKHNjaGVtYXMgPT4gKHsgcmVzcG9uc2U6IHsgcmVzdWx0czogc2NoZW1hcyB9IH0pKTtcbn1cblxuZnVuY3Rpb24gZ2V0T25lU2NoZW1hKHJlcSkge1xuICBjb25zdCBjbGFzc05hbWUgPSByZXEucGFyYW1zLmNsYXNzTmFtZTtcbiAgcmV0dXJuIHJlcS5jb25maWcuZGF0YWJhc2UubG9hZFNjaGVtYSh7IGNsZWFyQ2FjaGU6IHRydWV9KVxuICAgIC50aGVuKHNjaGVtYUNvbnRyb2xsZXIgPT4gc2NoZW1hQ29udHJvbGxlci5nZXRPbmVTY2hlbWEoY2xhc3NOYW1lLCB0cnVlKSlcbiAgICAudGhlbihzY2hlbWEgPT4gKHsgcmVzcG9uc2U6IHNjaGVtYSB9KSlcbiAgICAuY2F0Y2goZXJyb3IgPT4ge1xuICAgICAgaWYgKGVycm9yID09PSB1bmRlZmluZWQpIHtcbiAgICAgICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFBhcnNlLkVycm9yLklOVkFMSURfQ0xBU1NfTkFNRSwgYENsYXNzICR7Y2xhc3NOYW1lfSBkb2VzIG5vdCBleGlzdC5gKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IG5ldyBQYXJzZS5FcnJvcihQYXJzZS5FcnJvci5JTlRFUk5BTF9TRVJWRVJfRVJST1IsICdEYXRhYmFzZSBhZGFwdGVyIGVycm9yLicpO1xuICAgICAgfVxuICAgIH0pO1xufVxuXG5mdW5jdGlvbiBjcmVhdGVTY2hlbWEocmVxKSB7XG4gIGlmIChyZXEuYXV0aC5pc1JlYWRPbmx5KSB7XG4gICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFBhcnNlLkVycm9yLk9QRVJBVElPTl9GT1JCSURERU4sICdyZWFkLW9ubHkgbWFzdGVyS2V5IGlzblxcJ3QgYWxsb3dlZCB0byBjcmVhdGUgYSBzY2hlbWEuJyk7XG4gIH1cbiAgaWYgKHJlcS5wYXJhbXMuY2xhc3NOYW1lICYmIHJlcS5ib2R5LmNsYXNzTmFtZSkge1xuICAgIGlmIChyZXEucGFyYW1zLmNsYXNzTmFtZSAhPSByZXEuYm9keS5jbGFzc05hbWUpIHtcbiAgICAgIHJldHVybiBjbGFzc05hbWVNaXNtYXRjaFJlc3BvbnNlKHJlcS5ib2R5LmNsYXNzTmFtZSwgcmVxLnBhcmFtcy5jbGFzc05hbWUpO1xuICAgIH1cbiAgfVxuXG4gIGNvbnN0IGNsYXNzTmFtZSA9IHJlcS5wYXJhbXMuY2xhc3NOYW1lIHx8IHJlcS5ib2R5LmNsYXNzTmFtZTtcbiAgaWYgKCFjbGFzc05hbWUpIHtcbiAgICB0aHJvdyBuZXcgUGFyc2UuRXJyb3IoMTM1LCBgUE9TVCAke3JlcS5wYXRofSBuZWVkcyBhIGNsYXNzIG5hbWUuYCk7XG4gIH1cblxuICByZXR1cm4gcmVxLmNvbmZpZy5kYXRhYmFzZS5sb2FkU2NoZW1hKHsgY2xlYXJDYWNoZTogdHJ1ZX0pXG4gICAgLnRoZW4oc2NoZW1hID0+IHNjaGVtYS5hZGRDbGFzc0lmTm90RXhpc3RzKGNsYXNzTmFtZSwgcmVxLmJvZHkuZmllbGRzLCByZXEuYm9keS5jbGFzc0xldmVsUGVybWlzc2lvbnMsIHJlcS5ib2R5LmluZGV4ZXMpKVxuICAgIC50aGVuKHNjaGVtYSA9PiAoeyByZXNwb25zZTogc2NoZW1hIH0pKTtcbn1cblxuZnVuY3Rpb24gbW9kaWZ5U2NoZW1hKHJlcSkge1xuICBpZiAocmVxLmF1dGguaXNSZWFkT25seSkge1xuICAgIHRocm93IG5ldyBQYXJzZS5FcnJvcihQYXJzZS5FcnJvci5PUEVSQVRJT05fRk9SQklEREVOLCAncmVhZC1vbmx5IG1hc3RlcktleSBpc25cXCd0IGFsbG93ZWQgdG8gdXBkYXRlIGEgc2NoZW1hLicpO1xuICB9XG4gIGlmIChyZXEuYm9keS5jbGFzc05hbWUgJiYgcmVxLmJvZHkuY2xhc3NOYW1lICE9IHJlcS5wYXJhbXMuY2xhc3NOYW1lKSB7XG4gICAgcmV0dXJuIGNsYXNzTmFtZU1pc21hdGNoUmVzcG9uc2UocmVxLmJvZHkuY2xhc3NOYW1lLCByZXEucGFyYW1zLmNsYXNzTmFtZSk7XG4gIH1cblxuICBjb25zdCBzdWJtaXR0ZWRGaWVsZHMgPSByZXEuYm9keS5maWVsZHMgfHwge307XG4gIGNvbnN0IGNsYXNzTmFtZSA9IHJlcS5wYXJhbXMuY2xhc3NOYW1lO1xuXG4gIHJldHVybiByZXEuY29uZmlnLmRhdGFiYXNlLmxvYWRTY2hlbWEoeyBjbGVhckNhY2hlOiB0cnVlfSlcbiAgICAudGhlbihzY2hlbWEgPT4gc2NoZW1hLnVwZGF0ZUNsYXNzKGNsYXNzTmFtZSwgc3VibWl0dGVkRmllbGRzLCByZXEuYm9keS5jbGFzc0xldmVsUGVybWlzc2lvbnMsIHJlcS5ib2R5LmluZGV4ZXMsIHJlcS5jb25maWcuZGF0YWJhc2UpKVxuICAgIC50aGVuKHJlc3VsdCA9PiAoe3Jlc3BvbnNlOiByZXN1bHR9KSk7XG59XG5cbmNvbnN0IGRlbGV0ZVNjaGVtYSA9IHJlcSA9PiB7XG4gIGlmIChyZXEuYXV0aC5pc1JlYWRPbmx5KSB7XG4gICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFBhcnNlLkVycm9yLk9QRVJBVElPTl9GT1JCSURERU4sICdyZWFkLW9ubHkgbWFzdGVyS2V5IGlzblxcJ3QgYWxsb3dlZCB0byBkZWxldGUgYSBzY2hlbWEuJyk7XG4gIH1cbiAgaWYgKCFTY2hlbWFDb250cm9sbGVyLmNsYXNzTmFtZUlzVmFsaWQocmVxLnBhcmFtcy5jbGFzc05hbWUpKSB7XG4gICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFBhcnNlLkVycm9yLklOVkFMSURfQ0xBU1NfTkFNRSwgU2NoZW1hQ29udHJvbGxlci5pbnZhbGlkQ2xhc3NOYW1lTWVzc2FnZShyZXEucGFyYW1zLmNsYXNzTmFtZSkpO1xuICB9XG4gIHJldHVybiByZXEuY29uZmlnLmRhdGFiYXNlLmRlbGV0ZVNjaGVtYShyZXEucGFyYW1zLmNsYXNzTmFtZSlcbiAgICAudGhlbigoKSA9PiAoeyByZXNwb25zZToge30gfSkpO1xufVxuXG5leHBvcnQgY2xhc3MgU2NoZW1hc1JvdXRlciBleHRlbmRzIFByb21pc2VSb3V0ZXIge1xuICBtb3VudFJvdXRlcygpIHtcbiAgICB0aGlzLnJvdXRlKCdHRVQnLCAnL3NjaGVtYXMnLCBtaWRkbGV3YXJlLnByb21pc2VFbmZvcmNlTWFzdGVyS2V5QWNjZXNzLCBnZXRBbGxTY2hlbWFzKTtcbiAgICB0aGlzLnJvdXRlKCdHRVQnLCAnL3NjaGVtYXMvOmNsYXNzTmFtZScsIG1pZGRsZXdhcmUucHJvbWlzZUVuZm9yY2VNYXN0ZXJLZXlBY2Nlc3MsIGdldE9uZVNjaGVtYSk7XG4gICAgdGhpcy5yb3V0ZSgnUE9TVCcsICcvc2NoZW1hcycsIG1pZGRsZXdhcmUucHJvbWlzZUVuZm9yY2VNYXN0ZXJLZXlBY2Nlc3MsIGNyZWF0ZVNjaGVtYSk7XG4gICAgdGhpcy5yb3V0ZSgnUE9TVCcsICcvc2NoZW1hcy86Y2xhc3NOYW1lJywgbWlkZGxld2FyZS5wcm9taXNlRW5mb3JjZU1hc3RlcktleUFjY2VzcywgY3JlYXRlU2NoZW1hKTtcbiAgICB0aGlzLnJvdXRlKCdQVVQnLCAnL3NjaGVtYXMvOmNsYXNzTmFtZScsIG1pZGRsZXdhcmUucHJvbWlzZUVuZm9yY2VNYXN0ZXJLZXlBY2Nlc3MsIG1vZGlmeVNjaGVtYSk7XG4gICAgdGhpcy5yb3V0ZSgnREVMRVRFJywgJy9zY2hlbWFzLzpjbGFzc05hbWUnLCBtaWRkbGV3YXJlLnByb21pc2VFbmZvcmNlTWFzdGVyS2V5QWNjZXNzLCBkZWxldGVTY2hlbWEpO1xuICB9XG59XG4iXX0=