'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.HooksRouter = undefined;

var _node = require('parse/node');

var _PromiseRouter = require('../PromiseRouter');

var _PromiseRouter2 = _interopRequireDefault(_PromiseRouter);

var _middlewares = require('../middlewares');

var middleware = _interopRequireWildcard(_middlewares);

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class HooksRouter extends _PromiseRouter2.default {
  createHook(aHook, config) {
    return config.hooksController.createHook(aHook).then(hook => ({ response: hook }));
  }

  updateHook(aHook, config) {
    return config.hooksController.updateHook(aHook).then(hook => ({ response: hook }));
  }

  handlePost(req) {
    return this.createHook(req.body, req.config);
  }

  handleGetFunctions(req) {
    var hooksController = req.config.hooksController;
    if (req.params.functionName) {
      return hooksController.getFunction(req.params.functionName).then(foundFunction => {
        if (!foundFunction) {
          throw new _node.Parse.Error(143, `no function named: ${req.params.functionName} is defined`);
        }
        return Promise.resolve({ response: foundFunction });
      });
    }

    return hooksController.getFunctions().then(functions => {
      return { response: functions || [] };
    }, err => {
      throw err;
    });
  }

  handleGetTriggers(req) {
    var hooksController = req.config.hooksController;
    if (req.params.className && req.params.triggerName) {

      return hooksController.getTrigger(req.params.className, req.params.triggerName).then(foundTrigger => {
        if (!foundTrigger) {
          throw new _node.Parse.Error(143, `class ${req.params.className} does not exist`);
        }
        return Promise.resolve({ response: foundTrigger });
      });
    }

    return hooksController.getTriggers().then(triggers => ({ response: triggers || [] }));
  }

  handleDelete(req) {
    var hooksController = req.config.hooksController;
    if (req.params.functionName) {
      return hooksController.deleteFunction(req.params.functionName).then(() => ({ response: {} }));
    } else if (req.params.className && req.params.triggerName) {
      return hooksController.deleteTrigger(req.params.className, req.params.triggerName).then(() => ({ response: {} }));
    }
    return Promise.resolve({ response: {} });
  }

  handleUpdate(req) {
    var hook;
    if (req.params.functionName && req.body.url) {
      hook = {};
      hook.functionName = req.params.functionName;
      hook.url = req.body.url;
    } else if (req.params.className && req.params.triggerName && req.body.url) {
      hook = {};
      hook.className = req.params.className;
      hook.triggerName = req.params.triggerName;
      hook.url = req.body.url;
    } else {
      throw new _node.Parse.Error(143, "invalid hook declaration");
    }
    return this.updateHook(hook, req.config);
  }

  handlePut(req) {
    var body = req.body;
    if (body.__op == "Delete") {
      return this.handleDelete(req);
    } else {
      return this.handleUpdate(req);
    }
  }

  mountRoutes() {
    this.route('GET', '/hooks/functions', middleware.promiseEnforceMasterKeyAccess, this.handleGetFunctions.bind(this));
    this.route('GET', '/hooks/triggers', middleware.promiseEnforceMasterKeyAccess, this.handleGetTriggers.bind(this));
    this.route('GET', '/hooks/functions/:functionName', middleware.promiseEnforceMasterKeyAccess, this.handleGetFunctions.bind(this));
    this.route('GET', '/hooks/triggers/:className/:triggerName', middleware.promiseEnforceMasterKeyAccess, this.handleGetTriggers.bind(this));
    this.route('POST', '/hooks/functions', middleware.promiseEnforceMasterKeyAccess, this.handlePost.bind(this));
    this.route('POST', '/hooks/triggers', middleware.promiseEnforceMasterKeyAccess, this.handlePost.bind(this));
    this.route('PUT', '/hooks/functions/:functionName', middleware.promiseEnforceMasterKeyAccess, this.handlePut.bind(this));
    this.route('PUT', '/hooks/triggers/:className/:triggerName', middleware.promiseEnforceMasterKeyAccess, this.handlePut.bind(this));
  }
}

exports.HooksRouter = HooksRouter;
exports.default = HooksRouter;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9Sb3V0ZXJzL0hvb2tzUm91dGVyLmpzIl0sIm5hbWVzIjpbIm1pZGRsZXdhcmUiLCJIb29rc1JvdXRlciIsIlByb21pc2VSb3V0ZXIiLCJjcmVhdGVIb29rIiwiYUhvb2siLCJjb25maWciLCJob29rc0NvbnRyb2xsZXIiLCJ0aGVuIiwiaG9vayIsInJlc3BvbnNlIiwidXBkYXRlSG9vayIsImhhbmRsZVBvc3QiLCJyZXEiLCJib2R5IiwiaGFuZGxlR2V0RnVuY3Rpb25zIiwicGFyYW1zIiwiZnVuY3Rpb25OYW1lIiwiZ2V0RnVuY3Rpb24iLCJmb3VuZEZ1bmN0aW9uIiwiUGFyc2UiLCJFcnJvciIsIlByb21pc2UiLCJyZXNvbHZlIiwiZ2V0RnVuY3Rpb25zIiwiZnVuY3Rpb25zIiwiZXJyIiwiaGFuZGxlR2V0VHJpZ2dlcnMiLCJjbGFzc05hbWUiLCJ0cmlnZ2VyTmFtZSIsImdldFRyaWdnZXIiLCJmb3VuZFRyaWdnZXIiLCJnZXRUcmlnZ2VycyIsInRyaWdnZXJzIiwiaGFuZGxlRGVsZXRlIiwiZGVsZXRlRnVuY3Rpb24iLCJkZWxldGVUcmlnZ2VyIiwiaGFuZGxlVXBkYXRlIiwidXJsIiwiaGFuZGxlUHV0IiwiX19vcCIsIm1vdW50Um91dGVzIiwicm91dGUiLCJwcm9taXNlRW5mb3JjZU1hc3RlcktleUFjY2VzcyIsImJpbmQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7QUFDQTs7OztBQUNBOztJQUFZQSxVOzs7Ozs7QUFFTCxNQUFNQyxXQUFOLFNBQTBCQyx1QkFBMUIsQ0FBd0M7QUFDN0NDLGFBQVdDLEtBQVgsRUFBa0JDLE1BQWxCLEVBQTBCO0FBQ3hCLFdBQU9BLE9BQU9DLGVBQVAsQ0FBdUJILFVBQXZCLENBQWtDQyxLQUFsQyxFQUF5Q0csSUFBekMsQ0FBK0NDLElBQUQsS0FBVyxFQUFDQyxVQUFVRCxJQUFYLEVBQVgsQ0FBOUMsQ0FBUDtBQUNEOztBQUVERSxhQUFXTixLQUFYLEVBQWtCQyxNQUFsQixFQUEwQjtBQUN4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VyxHQUFBQSxXO2tCQStGRUEsVyIsImZpbGUiOiJIb29rc1JvdXRlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFBhcnNlIH0gICAgICAgZnJvbSAncGFyc2Uvbm9kZSc7XG5pbXBvcnQgUHJvbWlzZVJvdXRlciAgIGZyb20gJy4uL1Byb21pc2VSb3V0ZXInO1xuaW1wb3J0ICogYXMgbWlkZGxld2FyZSBmcm9tIFwiLi4vbWlkZGxld2FyZXNcIjtcblxuZXhwb3J0IGNsYXNzIEhvb2tzUm91dGVyIGV4dGVuZHMgUHJvbWlzZVJvdXRlciB7XG4gIGNyZWF0ZUhvb2soYUhvb2ssIGNvbmZpZykge1xuICAgIHJldHVybiBjb25maWcuaG9va3NDb250cm9sbGVyLmNyZWF0ZUhvb2soYUhvb2spLnRoZW4oKGhvb2spID0+ICh7cmVzcG9uc2U6IGhvb2t9KSk7XG4gIH1cblxuICB1cGRhdGVIb29rKGFIb29rLCBjb25maWcpIHtcbiAgICByZXR1cm4gIGNvbmZpZy5ob29rc0NvbnRyb2xsZXIudXBkYXRlSG9vayhhSG9vaykudGhlbigoaG9vaykgPT4gKHtyZXNwb25zZTogaG9va30pKTtcbiAgfVxuXG4gIGhhbmRsZVBvc3QocmVxKSB7XG4gICAgcmV0dXJuIHRoaXMuY3JlYXRlSG9vayhyZXEuYm9keSwgcmVxLmNvbmZpZyk7XG4gIH1cblxuICBoYW5kbGVHZXRGdW5jdGlvbnMocmVxKSB7XG4gICAgdmFyIGhvb2tzQ29udHJvbGxlciA9IHJlcS5jb25maWcuaG9va3NDb250cm9sbGVyO1xuICAgIGlmIChyZXEucGFyYW1zLmZ1bmN0aW9uTmFtZSkge1xuICAgICAgcmV0dXJuIGhvb2tzQ29udHJvbGxlci5nZXRGdW5jdGlvbihyZXEucGFyYW1zLmZ1bmN0aW9uTmFtZSkudGhlbigoZm91bmRGdW5jdGlvbikgPT4ge1xuICAgICAgICBpZiAoIWZvdW5kRnVuY3Rpb24pIHtcbiAgICAgICAgICB0aHJvdyBuZXcgUGFyc2UuRXJyb3IoMTQzLCBgbm8gZnVuY3Rpb24gbmFtZWQ6ICR7cmVxLnBhcmFtcy5mdW5jdGlvbk5hbWV9IGlzIGRlZmluZWRgKTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHtyZXNwb25zZTogZm91bmRGdW5jdGlvbn0pO1xuICAgICAgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGhvb2tzQ29udHJvbGxlci5nZXRGdW5jdGlvbnMoKS50aGVuKChmdW5jdGlvbnMpID0+IHtcbiAgICAgIHJldHVybiB7IHJlc3BvbnNlOiBmdW5jdGlvbnMgfHwgW10gfTtcbiAgICB9LCAoZXJyKSA9PiB7XG4gICAgICB0aHJvdyBlcnI7XG4gICAgfSk7XG4gIH1cblxuICBoYW5kbGVHZXRUcmlnZ2VycyhyZXEpIHtcbiAgICB2YXIgaG9va3NDb250cm9sbGVyID0gcmVxLmNvbmZpZy5ob29rc0NvbnRyb2xsZXI7XG4gICAgaWYgKHJlcS5wYXJhbXMuY2xhc3NOYW1lICYmIHJlcS5wYXJhbXMudHJpZ2dlck5hbWUpIHtcblxuICAgICAgcmV0dXJuIGhvb2tzQ29udHJvbGxlci5nZXRUcmlnZ2VyKHJlcS5wYXJhbXMuY2xhc3NOYW1lLCByZXEucGFyYW1zLnRyaWdnZXJOYW1lKS50aGVuKChmb3VuZFRyaWdnZXIpID0+IHtcbiAgICAgICAgaWYgKCFmb3VuZFRyaWdnZXIpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgUGFyc2UuRXJyb3IoMTQzLGBjbGFzcyAke3JlcS5wYXJhbXMuY2xhc3NOYW1lfSBkb2VzIG5vdCBleGlzdGApO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoe3Jlc3BvbnNlOiBmb3VuZFRyaWdnZXJ9KTtcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIHJldHVybiBob29rc0NvbnRyb2xsZXIuZ2V0VHJpZ2dlcnMoKS50aGVuKCh0cmlnZ2VycykgPT4gKHsgcmVzcG9uc2U6IHRyaWdnZXJzIHx8IFtdIH0pKTtcbiAgfVxuXG4gIGhhbmRsZURlbGV0ZShyZXEpIHtcbiAgICB2YXIgaG9va3NDb250cm9sbGVyID0gcmVxLmNvbmZpZy5ob29rc0NvbnRyb2xsZXI7XG4gICAgaWYgKHJlcS5wYXJhbXMuZnVuY3Rpb25OYW1lKSB7XG4gICAgICByZXR1cm4gaG9va3NDb250cm9sbGVyLmRlbGV0ZUZ1bmN0aW9uKHJlcS5wYXJhbXMuZnVuY3Rpb25OYW1lKS50aGVuKCgpID0+ICh7cmVzcG9uc2U6IHt9fSkpXG5cbiAgICB9IGVsc2UgaWYgKHJlcS5wYXJhbXMuY2xhc3NOYW1lICYmIHJlcS5wYXJhbXMudHJpZ2dlck5hbWUpIHtcbiAgICAgIHJldHVybiBob29rc0NvbnRyb2xsZXIuZGVsZXRlVHJpZ2dlcihyZXEucGFyYW1zLmNsYXNzTmFtZSwgcmVxLnBhcmFtcy50cmlnZ2VyTmFtZSkudGhlbigoKSA9PiAoe3Jlc3BvbnNlOiB7fX0pKVxuICAgIH1cbiAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHtyZXNwb25zZToge319KTtcbiAgfVxuXG4gIGhhbmRsZVVwZGF0ZShyZXEpIHtcbiAgICB2YXIgaG9vaztcbiAgICBpZiAocmVxLnBhcmFtcy5mdW5jdGlvbk5hbWUgJiYgcmVxLmJvZHkudXJsKSB7XG4gICAgICBob29rID0ge31cbiAgICAgIGhvb2suZnVuY3Rpb25OYW1lID0gcmVxLnBhcmFtcy5mdW5jdGlvbk5hbWU7XG4gICAgICBob29rLnVybCA9IHJlcS5ib2R5LnVybDtcbiAgICB9IGVsc2UgaWYgKHJlcS5wYXJhbXMuY2xhc3NOYW1lICYmIHJlcS5wYXJhbXMudHJpZ2dlck5hbWUgJiYgcmVxLmJvZHkudXJsKSB7XG4gICAgICBob29rID0ge31cbiAgICAgIGhvb2suY2xhc3NOYW1lID0gcmVxLnBhcmFtcy5jbGFzc05hbWU7XG4gICAgICBob29rLnRyaWdnZXJOYW1lID0gcmVxLnBhcmFtcy50cmlnZ2VyTmFtZTtcbiAgICAgIGhvb2sudXJsID0gcmVxLmJvZHkudXJsXG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBQYXJzZS5FcnJvcigxNDMsIFwiaW52YWxpZCBob29rIGRlY2xhcmF0aW9uXCIpO1xuICAgIH1cbiAgICByZXR1cm4gdGhpcy51cGRhdGVIb29rKGhvb2ssIHJlcS5jb25maWcpO1xuICB9XG5cbiAgaGFuZGxlUHV0KHJlcSkge1xuICAgIHZhciBib2R5ID0gcmVxLmJvZHk7XG4gICAgaWYgKGJvZHkuX19vcCA9PSBcIkRlbGV0ZVwiKSB7XG4gICAgICByZXR1cm4gdGhpcy5oYW5kbGVEZWxldGUocmVxKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHRoaXMuaGFuZGxlVXBkYXRlKHJlcSk7XG4gICAgfVxuICB9XG5cbiAgbW91bnRSb3V0ZXMoKSB7XG4gICAgdGhpcy5yb3V0ZSgnR0VUJywgICcvaG9va3MvZnVuY3Rpb25zJywgbWlkZGxld2FyZS5wcm9taXNlRW5mb3JjZU1hc3RlcktleUFjY2VzcywgdGhpcy5oYW5kbGVHZXRGdW5jdGlvbnMuYmluZCh0aGlzKSk7XG4gICAgdGhpcy5yb3V0ZSgnR0VUJywgICcvaG9va3MvdHJpZ2dlcnMnLCBtaWRkbGV3YXJlLnByb21pc2VFbmZvcmNlTWFzdGVyS2V5QWNjZXNzLCB0aGlzLmhhbmRsZUdldFRyaWdnZXJzLmJpbmQodGhpcykpO1xuICAgIHRoaXMucm91dGUoJ0dFVCcsICAnL2hvb2tzL2Z1bmN0aW9ucy86ZnVuY3Rpb25OYW1lJywgbWlkZGxld2FyZS5wcm9taXNlRW5mb3JjZU1hc3RlcktleUFjY2VzcywgdGhpcy5oYW5kbGVHZXRGdW5jdGlvbnMuYmluZCh0aGlzKSk7XG4gICAgdGhpcy5yb3V0ZSgnR0VUJywgICcvaG9va3MvdHJpZ2dlcnMvOmNsYXNzTmFtZS86dHJpZ2dlck5hbWUnLCBtaWRkbGV3YXJlLnByb21pc2VFbmZvcmNlTWFzdGVyS2V5QWNjZXNzLCB0aGlzLmhhbmRsZUdldFRyaWdnZXJzLmJpbmQodGhpcykpO1xuICAgIHRoaXMucm91dGUoJ1BPU1QnLCAnL2hvb2tzL2Z1bmN0aW9ucycsIG1pZGRsZXdhcmUucHJvbWlzZUVuZm9yY2VNYXN0ZXJLZXlBY2Nlc3MsIHRoaXMuaGFuZGxlUG9zdC5iaW5kKHRoaXMpKTtcbiAgICB0aGlzLnJvdXRlKCdQT1NUJywgJy9ob29rcy90cmlnZ2VycycsIG1pZGRsZXdhcmUucHJvbWlzZUVuZm9yY2VNYXN0ZXJLZXlBY2Nlc3MsIHRoaXMuaGFuZGxlUG9zdC5iaW5kKHRoaXMpKTtcbiAgICB0aGlzLnJvdXRlKCdQVVQnLCAgJy9ob29rcy9mdW5jdGlvbnMvOmZ1bmN0aW9uTmFtZScsIG1pZGRsZXdhcmUucHJvbWlzZUVuZm9yY2VNYXN0ZXJLZXlBY2Nlc3MsIHRoaXMuaGFuZGxlUHV0LmJpbmQodGhpcykpO1xuICAgIHRoaXMucm91dGUoJ1BVVCcsICAnL2hvb2tzL3RyaWdnZXJzLzpjbGFzc05hbWUvOnRyaWdnZXJOYW1lJywgbWlkZGxld2FyZS5wcm9taXNlRW5mb3JjZU1hc3RlcktleUFjY2VzcywgdGhpcy5oYW5kbGVQdXQuYmluZCh0aGlzKSk7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgSG9va3NSb3V0ZXI7XG4iXX0=