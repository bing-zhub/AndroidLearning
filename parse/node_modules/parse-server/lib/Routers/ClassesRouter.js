'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.ClassesRouter = undefined;

var _PromiseRouter = require('../PromiseRouter');

var _PromiseRouter2 = _interopRequireDefault(_PromiseRouter);

var _rest = require('../rest');

var _rest2 = _interopRequireDefault(_rest);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _node = require('parse/node');

var _node2 = _interopRequireDefault(_node);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const ALLOWED_GET_QUERY_KEYS = ['keys', 'include'];

class ClassesRouter extends _PromiseRouter2.default {

  className(req) {
    return req.params.className;
  }

  handleFind(req) {
    const body = Object.assign(req.body, ClassesRouter.JSONFromQuery(req.query));
    const options = ClassesRouter.optionsFromBody(body);
    if (req.config.maxLimit && body.limit > req.config.maxLimit) {
      // Silently replace the limit on the query with the max configured
      options.limit = Number(req.config.maxLimit);
    }
    if (body.redirectClassNameForKey) {
      options.redirectClassNameForKey = String(body.redirectClassNameForKey);
    }
    if (typeof body.where === 'string') {
      body.where = JSON.parse(body.where);
    }
    return _rest2.default.find(req.config, req.auth, this.className(req), body.where, options, req.info.clientSDK).then(response => {
      return { response: response };
    });
  }

  // Returns a promise for a {response} object.
  handleGet(req) {
    const body = Object.assign(req.body, ClassesRouter.JSONFromQuery(req.query));
    const options = {};

    for (const key of Object.keys(body)) {
      if (ALLOWED_GET_QUERY_KEYS.indexOf(key) === -1) {
        throw new _node2.default.Error(_node2.default.Error.INVALID_QUERY, 'Improper encode of parameter');
      }
    }

    if (typeof body.keys == 'string') {
      options.keys = body.keys;
    }
    if (body.include) {
      options.include = String(body.include);
    }

    return _rest2.default.get(req.config, req.auth, this.className(req), req.params.objectId, options, req.info.clientSDK).then(response => {
      if (!response.results || response.results.length == 0) {
        throw new _node2.default.Error(_node2.default.Error.OBJECT_NOT_FOUND, 'Object not found.');
      }

      if (this.className(req) === "_User") {

        delete response.results[0].sessionToken;

        const user = response.results[0];

        if (req.auth.user && user.objectId == req.auth.user.id) {
          // Force the session token
          response.results[0].sessionToken = req.info.sessionToken;
        }
      }
      return { response: response.results[0] };
    });
  }

  handleCreate(req) {
    return _rest2.default.create(req.config, req.auth, this.className(req), req.body, req.info.clientSDK);
  }

  handleUpdate(req) {
    const where = { objectId: req.params.objectId };
    return _rest2.default.update(req.config, req.auth, this.className(req), where, req.body, req.info.clientSDK);
  }

  handleDelete(req) {
    return _rest2.default.del(req.config, req.auth, this.className(req), req.params.objectId, req.info.clientSDK).then(() => {
      return { response: {} };
    });
  }

  static JSONFromQuery(query) {
    const json = {};
    for (const [key, value] of _lodash2.default.entries(query)) {
      try {
        json[key] = JSON.parse(value);
      } catch (e) {
        json[key] = value;
      }
    }
    return json;
  }

  static optionsFromBody(body) {
    const allowConstraints = ['skip', 'limit', 'order', 'count', 'keys', 'include', 'includeAll', 'redirectClassNameForKey', 'where'];

    for (const key of Object.keys(body)) {
      if (allowConstraints.indexOf(key) === -1) {
        throw new _node2.default.Error(_node2.default.Error.INVALID_QUERY, `Invalid parameter for query: ${key}`);
      }
    }
    const options = {};
    if (body.skip) {
      options.skip = Number(body.skip);
    }
    if (body.limit || body.limit === 0) {
      options.limit = Number(body.limit);
    } else {
      options.limit = Number(100);
    }
    if (body.order) {
      options.order = String(body.order);
    }
    if (body.count) {
      options.count = true;
    }
    if (typeof body.keys == 'string') {
      options.keys = body.keys;
    }
    if (body.include) {
      options.include = String(body.include);
    }
    if (body.includeAll) {
      options.includeAll = true;
    }
    return options;
  }

  mountRoutes() {
    this.route('GET', '/classes/:className', req => {
      return this.handleFind(req);
    });
    this.route('GET', '/classes/:className/:objectId', req => {
      return this.handleGet(req);
    });
    this.route('POST', '/classes/:className', req => {
      return this.handleCreate(req);
    });
    this.route('PUT', '/classes/:className/:objectId', req => {
      return this.handleUpdate(req);
    });
    this.route('DELETE', '/classes/:className/:objectId', req => {
      return this.handleDelete(req);
    });
  }
}

exports.ClassesRouter = ClassesRouter;
exports.default = ClassesRouter;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9Sb3V0ZXJzL0NsYXNzZXNSb3V0ZXIuanMiXSwibmFtZXMiOlsiQUxMT1dFRF9HRVRfUVVFUllfS0VZUyIsIkNsYXNzZXNSb3V0ZXIiLCJQcm9taXNlUm91dGVyIiwiY2xhc3NOYW1lIiwicmVxIiwicGFyYW1zIiwiaGFuZGxlRmluZCIsImJvZHkiLCJPYmplY3QiLCJhc3NpZ24iLCJKU09ORnJvbVF1ZXJ5IiwicXVlcnkiLCJvcHRpb25zIiwib3B0aW9uc0Zyb21Cb2R5IiwiY29uZmlnIiwibWF4TGltaXQiLCJsaW1pdCIsIk51bWJlciIsInJlZGlyZWN0Q2xhc3NOYW1lRm9yS2V5IiwiU3RyaW5nIiwid2hlcmUiLCJKU09OIiwicGFyc2UiLCJyZXN0IiwiZmluZCIsImF1dGgiLCJpbmZvIiwiY2xpZW50U0RLIiwidGhlbiIsInJlc3BvbnNlIiwiaGFuZGxlR2V0Iiwia2V5Iiwia2V5cyIsImluZGV4T2YiLCJQYXJzZSIsIkVycm9yIiwiSU5WQUxJRF9RVUVSWSIsImluY2x1ZGUiLCJnZXQiLCJvYmplY3RJZCIsInJlc3VsdHMiLCJsZW5ndGgiLCJPQkpFQ1RfTk9UX0ZPVU5EIiwic2Vzc2lvblRva2VuIiwidXNlciIsImlkIiwiaGFuZGxlQ3JlYXRlIiwiY3JlYXRlIiwiaGFuZGxlVXBkYXRlIiwidXBkYXRlIiwiaGFuZGxlRGVsZXRlIiwiZGVsIiwianNvbiIsInZhbHVlIiwiXyIsImVudHJpZXMiLCJlIiwiYWxsb3dDb25zdHJhaW50cyIsInNraXAiLCJvcmRlciIsImNvdW50IiwiaW5jbHVkZUFsbCIsIm1vdW50Um91dGVzIiwicm91dGUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFDQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7Ozs7O0FBRUEsTUFBTUEseUJBQXlCLENBQUMsTUFBRCxFQUFTLFNBQVQsQ0FBL0I7O0FBRU8sTUFBTUMsYUFBTixTQUE0QkMsdUJBQTVCLENBQTBDOztBQUUvQ0MsWUFBVUMsR0FBVixFQUFlO0FBQ2Is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LFlBQUwsQ0FBa0IxQyxHQUFsQixDQUFQO0FBQWdDLEtBQXJGO0FBQ0EsU0FBSzJELEtBQUwsQ0FBVyxLQUFYLEVBQWtCLCtCQUFsQixFQUFvRDNELEdBQUQsSUFBUztBQUFFLGFBQU8sS0FBSzRDLFlBQUwsQ0FBa0I1QyxHQUFsQixDQUFQO0FBQWdDLEtBQTlGO0FBQ0EsU0FBSzJELEtBQUwsQ0FBVyxRQUFYLEVBQXNCLCtCQUF0QixFQUF3RDNELEdBQUQsSUFBUztBQUFFLGFBQU8sS0FBSzhDLFlBQUwsQ0FBa0I5QyxHQUFsQixDQUFQO0FBQWdDLEtBQWxHO0FBQ0Q7QUF0SThDOztRQUFwQ0gsYSxHQUFBQSxhO2tCQXlJRUEsYSIsImZpbGUiOiJDbGFzc2VzUm91dGVyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiXG5pbXBvcnQgUHJvbWlzZVJvdXRlciBmcm9tICcuLi9Qcm9taXNlUm91dGVyJztcbmltcG9ydCByZXN0ICAgICAgICAgIGZyb20gJy4uL3Jlc3QnO1xuaW1wb3J0IF8gICAgICAgICAgICAgZnJvbSAnbG9kYXNoJztcbmltcG9ydCBQYXJzZSAgICAgICAgIGZyb20gJ3BhcnNlL25vZGUnO1xuXG5jb25zdCBBTExPV0VEX0dFVF9RVUVSWV9LRVlTID0gWydrZXlzJywgJ2luY2x1ZGUnXTtcblxuZXhwb3J0IGNsYXNzIENsYXNzZXNSb3V0ZXIgZXh0ZW5kcyBQcm9taXNlUm91dGVyIHtcblxuICBjbGFzc05hbWUocmVxKSB7XG4gICAgcmV0dXJuIHJlcS5wYXJhbXMuY2xhc3NOYW1lO1xuICB9XG5cbiAgaGFuZGxlRmluZChyZXEpIHtcbiAgICBjb25zdCBib2R5ID0gT2JqZWN0LmFzc2lnbihyZXEuYm9keSwgQ2xhc3Nlc1JvdXRlci5KU09ORnJvbVF1ZXJ5KHJlcS5xdWVyeSkpO1xuICAgIGNvbnN0IG9wdGlvbnMgPSBDbGFzc2VzUm91dGVyLm9wdGlvbnNGcm9tQm9keShib2R5KTtcbiAgICBpZiAocmVxLmNvbmZpZy5tYXhMaW1pdCAmJiAoYm9keS5saW1pdCA+IHJlcS5jb25maWcubWF4TGltaXQpKSB7XG4gICAgICAvLyBTaWxlbnRseSByZXBsYWNlIHRoZSBsaW1pdCBvbiB0aGUgcXVlcnkgd2l0aCB0aGUgbWF4IGNvbmZpZ3VyZWRcbiAgICAgIG9wdGlvbnMubGltaXQgPSBOdW1iZXIocmVxLmNvbmZpZy5tYXhMaW1pdCk7XG4gICAgfVxuICAgIGlmIChib2R5LnJlZGlyZWN0Q2xhc3NOYW1lRm9yS2V5KSB7XG4gICAgICBvcHRpb25zLnJlZGlyZWN0Q2xhc3NOYW1lRm9yS2V5ID0gU3RyaW5nKGJvZHkucmVkaXJlY3RDbGFzc05hbWVGb3JLZXkpO1xuICAgIH1cbiAgICBpZiAodHlwZW9mIGJvZHkud2hlcmUgPT09ICdzdHJpbmcnKSB7XG4gICAgICBib2R5LndoZXJlID0gSlNPTi5wYXJzZShib2R5LndoZXJlKTtcbiAgICB9XG4gICAgcmV0dXJuIHJlc3QuZmluZChyZXEuY29uZmlnLCByZXEuYXV0aCwgdGhpcy5jbGFzc05hbWUocmVxKSwgYm9keS53aGVyZSwgb3B0aW9ucywgcmVxLmluZm8uY2xpZW50U0RLKVxuICAgICAgLnRoZW4oKHJlc3BvbnNlKSA9PiB7XG4gICAgICAgIHJldHVybiB7IHJlc3BvbnNlOiByZXNwb25zZSB9O1xuICAgICAgfSk7XG4gIH1cblxuICAvLyBSZXR1cm5zIGEgcHJvbWlzZSBmb3IgYSB7cmVzcG9uc2V9IG9iamVjdC5cbiAgaGFuZGxlR2V0KHJlcSkge1xuICAgIGNvbnN0IGJvZHkgPSBPYmplY3QuYXNzaWduKHJlcS5ib2R5LCBDbGFzc2VzUm91dGVyLkpTT05Gcm9tUXVlcnkocmVxLnF1ZXJ5KSk7XG4gICAgY29uc3Qgb3B0aW9ucyA9IHt9O1xuXG4gICAgZm9yIChjb25zdCBrZXkgb2YgT2JqZWN0LmtleXMoYm9keSkpIHtcbiAgICAgIGlmIChBTExPV0VEX0dFVF9RVUVSWV9LRVlTLmluZGV4T2Yoa2V5KSA9PT0gLTEpIHtcbiAgICAgICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFBhcnNlLkVycm9yLklOVkFMSURfUVVFUlksICdJbXByb3BlciBlbmNvZGUgb2YgcGFyYW1ldGVyJyk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKHR5cGVvZiBib2R5LmtleXMgPT0gJ3N0cmluZycpIHtcbiAgICAgIG9wdGlvbnMua2V5cyA9IGJvZHkua2V5cztcbiAgICB9XG4gICAgaWYgKGJvZHkuaW5jbHVkZSkge1xuICAgICAgb3B0aW9ucy5pbmNsdWRlID0gU3RyaW5nKGJvZHkuaW5jbHVkZSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlc3QuZ2V0KHJlcS5jb25maWcsIHJlcS5hdXRoLCB0aGlzLmNsYXNzTmFtZShyZXEpLCByZXEucGFyYW1zLm9iamVjdElkLCBvcHRpb25zLCByZXEuaW5mby5jbGllbnRTREspXG4gICAgICAudGhlbigocmVzcG9uc2UpID0+IHtcbiAgICAgICAgaWYgKCFyZXNwb25zZS5yZXN1bHRzIHx8IHJlc3BvbnNlLnJlc3VsdHMubGVuZ3RoID09IDApIHtcbiAgICAgICAgICB0aHJvdyBuZXcgUGFyc2UuRXJyb3IoUGFyc2UuRXJyb3IuT0JKRUNUX05PVF9GT1VORCwgJ09iamVjdCBub3QgZm91bmQuJyk7XG4gICAgICAgIH1cblxuICAgICAgICBpZiAodGhpcy5jbGFzc05hbWUocmVxKSA9PT0gXCJfVXNlclwiKSB7XG5cbiAgICAgICAgICBkZWxldGUgcmVzcG9uc2UucmVzdWx0c1swXS5zZXNzaW9uVG9rZW47XG5cbiAgICAgICAgICBjb25zdCB1c2VyID0gIHJlc3BvbnNlLnJlc3VsdHNbMF07XG5cbiAgICAgICAgICBpZiAocmVxLmF1dGgudXNlciAmJiB1c2VyLm9iamVjdElkID09IHJlcS5hdXRoLnVzZXIuaWQpIHtcbiAgICAgICAgICAgIC8vIEZvcmNlIHRoZSBzZXNzaW9uIHRva2VuXG4gICAgICAgICAgICByZXNwb25zZS5yZXN1bHRzWzBdLnNlc3Npb25Ub2tlbiA9IHJlcS5pbmZvLnNlc3Npb25Ub2tlbjtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHsgcmVzcG9uc2U6IHJlc3BvbnNlLnJlc3VsdHNbMF0gfTtcbiAgICAgIH0pO1xuICB9XG5cbiAgaGFuZGxlQ3JlYXRlKHJlcSkge1xuICAgIHJldHVybiByZXN0LmNyZWF0ZShyZXEuY29uZmlnLCByZXEuYXV0aCwgdGhpcy5jbGFzc05hbWUocmVxKSwgcmVxLmJvZHksIHJlcS5pbmZvLmNsaWVudFNESyk7XG4gIH1cblxuICBoYW5kbGVVcGRhdGUocmVxKSB7XG4gICAgY29uc3Qgd2hlcmUgPSB7IG9iamVjdElkOiByZXEucGFyYW1zLm9iamVjdElkIH1cbiAgICByZXR1cm4gcmVzdC51cGRhdGUocmVxLmNvbmZpZywgcmVxLmF1dGgsIHRoaXMuY2xhc3NOYW1lKHJlcSksIHdoZXJlLCByZXEuYm9keSwgcmVxLmluZm8uY2xpZW50U0RLKTtcbiAgfVxuXG4gIGhhbmRsZURlbGV0ZShyZXEpIHtcbiAgICByZXR1cm4gcmVzdC5kZWwocmVxLmNvbmZpZywgcmVxLmF1dGgsIHRoaXMuY2xhc3NOYW1lKHJlcSksIHJlcS5wYXJhbXMub2JqZWN0SWQsIHJlcS5pbmZvLmNsaWVudFNESylcbiAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgcmV0dXJuIHtyZXNwb25zZToge319O1xuICAgICAgfSk7XG4gIH1cblxuICBzdGF0aWMgSlNPTkZyb21RdWVyeShxdWVyeSkge1xuICAgIGNvbnN0IGpzb24gPSB7fTtcbiAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBfLmVudHJpZXMocXVlcnkpKSB7XG4gICAgICB0cnkge1xuICAgICAgICBqc29uW2tleV0gPSBKU09OLnBhcnNlKHZhbHVlKTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAganNvbltrZXldID0gdmFsdWU7XG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiBqc29uXG4gIH1cblxuICBzdGF0aWMgb3B0aW9uc0Zyb21Cb2R5KGJvZHkpIHtcbiAgICBjb25zdCBhbGxvd0NvbnN0cmFpbnRzID0gWydza2lwJywgJ2xpbWl0JywgJ29yZGVyJywgJ2NvdW50JywgJ2tleXMnLFxuICAgICAgJ2luY2x1ZGUnLCAnaW5jbHVkZUFsbCcsICdyZWRpcmVjdENsYXNzTmFtZUZvcktleScsICd3aGVyZSddO1xuXG4gICAgZm9yIChjb25zdCBrZXkgb2YgT2JqZWN0LmtleXMoYm9keSkpIHtcbiAgICAgIGlmIChhbGxvd0NvbnN0cmFpbnRzLmluZGV4T2Yoa2V5KSA9PT0gLTEpIHtcbiAgICAgICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFBhcnNlLkVycm9yLklOVkFMSURfUVVFUlksIGBJbnZhbGlkIHBhcmFtZXRlciBmb3IgcXVlcnk6ICR7a2V5fWApO1xuICAgICAgfVxuICAgIH1cbiAgICBjb25zdCBvcHRpb25zID0ge307XG4gICAgaWYgKGJvZHkuc2tpcCkge1xuICAgICAgb3B0aW9ucy5za2lwID0gTnVtYmVyKGJvZHkuc2tpcCk7XG4gICAgfVxuICAgIGlmIChib2R5LmxpbWl0IHx8IGJvZHkubGltaXQgPT09IDApIHtcbiAgICAgIG9wdGlvbnMubGltaXQgPSBOdW1iZXIoYm9keS5saW1pdCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIG9wdGlvbnMubGltaXQgPSBOdW1iZXIoMTAwKTtcbiAgICB9XG4gICAgaWYgKGJvZHkub3JkZXIpIHtcbiAgICAgIG9wdGlvbnMub3JkZXIgPSBTdHJpbmcoYm9keS5vcmRlcik7XG4gICAgfVxuICAgIGlmIChib2R5LmNvdW50KSB7XG4gICAgICBvcHRpb25zLmNvdW50ID0gdHJ1ZTtcbiAgICB9XG4gICAgaWYgKHR5cGVvZiBib2R5LmtleXMgPT0gJ3N0cmluZycpIHtcbiAgICAgIG9wdGlvbnMua2V5cyA9IGJvZHkua2V5cztcbiAgICB9XG4gICAgaWYgKGJvZHkuaW5jbHVkZSkge1xuICAgICAgb3B0aW9ucy5pbmNsdWRlID0gU3RyaW5nKGJvZHkuaW5jbHVkZSk7XG4gICAgfVxuICAgIGlmIChib2R5LmluY2x1ZGVBbGwpIHtcbiAgICAgIG9wdGlvbnMuaW5jbHVkZUFsbCA9IHRydWU7XG4gICAgfVxuICAgIHJldHVybiBvcHRpb25zO1xuICB9XG5cbiAgbW91bnRSb3V0ZXMoKSB7XG4gICAgdGhpcy5yb3V0ZSgnR0VUJywgJy9jbGFzc2VzLzpjbGFzc05hbWUnLCAocmVxKSA9PiB7IHJldHVybiB0aGlzLmhhbmRsZUZpbmQocmVxKTsgfSk7XG4gICAgdGhpcy5yb3V0ZSgnR0VUJywgJy9jbGFzc2VzLzpjbGFzc05hbWUvOm9iamVjdElkJywgKHJlcSkgPT4geyByZXR1cm4gdGhpcy5oYW5kbGVHZXQocmVxKTsgfSk7XG4gICAgdGhpcy5yb3V0ZSgnUE9TVCcsICcvY2xhc3Nlcy86Y2xhc3NOYW1lJywgKHJlcSkgPT4geyByZXR1cm4gdGhpcy5oYW5kbGVDcmVhdGUocmVxKTsgfSk7XG4gICAgdGhpcy5yb3V0ZSgnUFVUJywgJy9jbGFzc2VzLzpjbGFzc05hbWUvOm9iamVjdElkJywgKHJlcSkgPT4geyByZXR1cm4gdGhpcy5oYW5kbGVVcGRhdGUocmVxKTsgfSk7XG4gICAgdGhpcy5yb3V0ZSgnREVMRVRFJywgICcvY2xhc3Nlcy86Y2xhc3NOYW1lLzpvYmplY3RJZCcsIChyZXEpID0+IHsgcmV0dXJuIHRoaXMuaGFuZGxlRGVsZXRlKHJlcSk7IH0pO1xuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IENsYXNzZXNSb3V0ZXI7XG4iXX0=