'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
const Config = require('./Config');
const Auth = require('./Auth');
const RESTController = require('parse/lib/node/RESTController');
const URL = require('url');
const Parse = require('parse/node');

function getSessionToken(options) {
  if (options && typeof options.sessionToken === 'string') {
    return Parse.Promise.as(options.sessionToken);
  }
  return Parse.Promise.as(null);
}

function getAuth(options = {}, config) {
  const installationId = options.installationId || 'cloud';
  if (options.useMasterKey) {
    return Parse.Promise.as(new Auth.Auth({ config, isMaster: true, installationId }));
  }
  return getSessionToken(options).then(sessionToken => {
    if (sessionToken) {
      options.sessionToken = sessionToken;
      return Auth.getAuthForSessionToken({
        config,
        sessionToken: sessionToken,
        installationId
      });
    } else {
      return Parse.Promise.as(new Auth.Auth({ config, installationId }));
    }
  });
}

function ParseServerRESTController(applicationId, router) {
  function handleRequest(method, path, data = {}, options = {}) {
    // Store the arguments, for later use if internal fails
    const args = arguments;

    const config = Config.get(applicationId);
    const serverURL = URL.parse(config.serverURL);
    if (path.indexOf(serverURL.path) === 0) {
      path = path.slice(serverURL.path.length, path.length);
    }

    if (path[0] !== "/") {
      path = "/" + path;
    }

    if (path === '/batch') {
      const promises = data.requests.map(request => {
        return handleRequest(request.method, request.path, request.body, options).then(response => {
          return Parse.Promise.as({ success: response });
        }, error => {
          return Parse.Promise.as({ error: { code: error.code, error: error.message } });
        });
      });
      return Parse.Promise.all(promises);
    }

    let query;
    if (method === 'GET') {
      query = data;
    }

    return new Parse.Promise((resolve, reject) => {
      getAuth(options, config).then(auth => {
        const request = {
          body: data,
          config,
          auth,
          info: {
            applicationId: applicationId,
            sessionToken: options.sessionToken
          },
          query
        };
        return Promise.resolve().then(() => {
          return router.tryRouteRequest(method, path, request);
        }).then(response => {
          resolve(response.response, response.status, response);
        }, err => {
          if (err instanceof Parse.Error && err.code == Parse.Error.INVALID_JSON && err.message == `cannot route ${method} ${path}`) {
            RESTController.request.apply(null, args).then(resolve, reject);
          } else {
            reject(err);
          }
        });
      }, reject);
    });
  }

  return {
    request: handleRequest,
    ajax: RESTController.ajax
  };
}

exports.default = ParseServerRESTController;
exports.ParseServerRESTController = ParseServerRESTController;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9QYXJzZVNlcnZlclJFU1RDb250cm9sbGVyLmpzIl0sIm5hbWVzIjpbIkNvbmZpZyIsInJlcXVpcmUiLCJBdXRoIiwiUkVTVENvbnRyb2xsZXIiLCJVUkwiLCJQYXJzZSIsImdldFNlc3Npb25Ub2tlbiIsIm9wdGlvbnMiLCJzZXNzaW9uVG9rZW4iLCJQcm9taXNlIiwiYXMiLCJnZXRBdXRoIiwiY29uZmlnIiwiaW5zdGFsbGF0aW9uSWQiLCJ1c2VNYXN0ZXJLZXkiLCJpc01hc3RlciIsInRoZW4iLCJnZXRBdXRoRm9yU2Vzc2lvblRva2VuIiwiUGFyc2VTZXJ2ZXJSRVNUQ29udHJvbGxlciIsImFwcGxpY2F0aW9uSWQiLCJyb3V0ZXIiLCJoYW5kbGVSZXF1ZXN0IiwibWV0aG9kIiwicGF0aCIsImRhdGEiLCJhcmdzIiwiYXJndW1lbnRzIiwiZ2V0Iiwic2VydmVyVVJMIiwicGFyc2UiLCJpbmRleE9mIiwic2xpY2UiLCJsZW5ndGgiLCJwcm9taXNlcyIsInJlcXVlc3RzIiwibWFwIiwicmVxdWVzdCIsImJvZHkiLCJyZXNwb25zZSIsInN1Y2Nlc3MiLCJlcnJvciIsImNvZGUiLCJtZXNzYWdlIiwiYWxsIiwicXVlcnkiLCJyZXNvbHZlIiwicmVqZWN0IiwiYXV0aCIsImluZm8iLCJ0cnlSb3V0ZVJlcXVlc3QiLCJzdGF0dXMiLCJlcnIiLCJFcnJvciIsIklOVkFMSURfSlNPTiIsImFwcGx5IiwiYWpheCJdLCJtYXBwaW5ncyI6Ijs7Ozs7QUFBQSxNQUFNQSxTQUFTQyxRQUFRLFVBQVIsQ0FBZjtBQUNBLE1BQU1DLE9BQU9ELFFBQVEsUUFBUixDQUFiO0FBQ0EsTUFBTUUsaUJBQWlCRixRQUFRLCtCQUFSLENBQXZCO0FBQ0EsTUFBTUcsTUFBTUgsUUFBUSxLQUFSLENBQVo7QUFDQSxNQUFNSSxRQUFRSixRQUFRLFlBQVIsQ0FBZDs7QUFFQSxTQUFTSyxlQUFULENBQXlCQyxPQUF6QixFQUFrQztBQUNoQyxNQUFJQSxXQUFXLE9BQU9BLFFBQVFD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eUIsR0FBQUEseUIiLCJmaWxlIjoiUGFyc2VTZXJ2ZXJSRVNUQ29udHJvbGxlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IENvbmZpZyA9IHJlcXVpcmUoJy4vQ29uZmlnJyk7XG5jb25zdCBBdXRoID0gcmVxdWlyZSgnLi9BdXRoJyk7XG5jb25zdCBSRVNUQ29udHJvbGxlciA9IHJlcXVpcmUoJ3BhcnNlL2xpYi9ub2RlL1JFU1RDb250cm9sbGVyJyk7XG5jb25zdCBVUkwgPSByZXF1aXJlKCd1cmwnKTtcbmNvbnN0IFBhcnNlID0gcmVxdWlyZSgncGFyc2Uvbm9kZScpO1xuXG5mdW5jdGlvbiBnZXRTZXNzaW9uVG9rZW4ob3B0aW9ucykge1xuICBpZiAob3B0aW9ucyAmJiB0eXBlb2Ygb3B0aW9ucy5zZXNzaW9uVG9rZW4gPT09ICdzdHJpbmcnKSB7XG4gICAgcmV0dXJuIFBhcnNlLlByb21pc2UuYXMob3B0aW9ucy5zZXNzaW9uVG9rZW4pO1xuICB9XG4gIHJldHVybiBQYXJzZS5Qcm9taXNlLmFzKG51bGwpO1xufVxuXG5mdW5jdGlvbiBnZXRBdXRoKG9wdGlvbnMgPSB7fSwgY29uZmlnKSB7XG4gIGNvbnN0IGluc3RhbGxhdGlvbklkID0gb3B0aW9ucy5pbnN0YWxsYXRpb25JZCB8fCAnY2xvdWQnO1xuICBpZiAob3B0aW9ucy51c2VNYXN0ZXJLZXkpIHtcbiAgICByZXR1cm4gUGFyc2UuUHJvbWlzZS5hcyhuZXcgQXV0aC5BdXRoKHtjb25maWcsIGlzTWFzdGVyOiB0cnVlLCBpbnN0YWxsYXRpb25JZCB9KSk7XG4gIH1cbiAgcmV0dXJuIGdldFNlc3Npb25Ub2tlbihvcHRpb25zKS50aGVuKChzZXNzaW9uVG9rZW4pID0+IHtcbiAgICBpZiAoc2Vzc2lvblRva2VuKSB7XG4gICAgICBvcHRpb25zLnNlc3Npb25Ub2tlbiA9IHNlc3Npb25Ub2tlbjtcbiAgICAgIHJldHVybiBBdXRoLmdldEF1dGhGb3JTZXNzaW9uVG9rZW4oe1xuICAgICAgICBjb25maWcsXG4gICAgICAgIHNlc3Npb25Ub2tlbjogc2Vzc2lvblRva2VuLFxuICAgICAgICBpbnN0YWxsYXRpb25JZFxuICAgICAgfSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBQYXJzZS5Qcm9taXNlLmFzKG5ldyBBdXRoLkF1dGgoeyBjb25maWcsIGluc3RhbGxhdGlvbklkIH0pKTtcbiAgICB9XG4gIH0pXG59XG5cbmZ1bmN0aW9uIFBhcnNlU2VydmVyUkVTVENvbnRyb2xsZXIoYXBwbGljYXRpb25JZCwgcm91dGVyKSB7XG4gIGZ1bmN0aW9uIGhhbmRsZVJlcXVlc3QobWV0aG9kLCBwYXRoLCBkYXRhID0ge30sIG9wdGlvbnMgPSB7fSkge1xuICAgIC8vIFN0b3JlIHRoZSBhcmd1bWVudHMsIGZvciBsYXRlciB1c2UgaWYgaW50ZXJuYWwgZmFpbHNcbiAgICBjb25zdCBhcmdzID0gYXJndW1lbnRzO1xuXG4gICAgY29uc3QgY29uZmlnID0gQ29uZmlnLmdldChhcHBsaWNhdGlvbklkKTtcbiAgICBjb25zdCBzZXJ2ZXJVUkwgPSBVUkwucGFyc2UoY29uZmlnLnNlcnZlclVSTCk7XG4gICAgaWYgKHBhdGguaW5kZXhPZihzZXJ2ZXJVUkwucGF0aCkgPT09IDApIHtcbiAgICAgIHBhdGggPSBwYXRoLnNsaWNlKHNlcnZlclVSTC5wYXRoLmxlbmd0aCwgcGF0aC5sZW5ndGgpO1xuICAgIH1cblxuICAgIGlmIChwYXRoWzBdICE9PSBcIi9cIikge1xuICAgICAgcGF0aCA9IFwiL1wiICsgcGF0aDtcbiAgICB9XG5cbiAgICBpZiAocGF0aCA9PT0gJy9iYXRjaCcpIHtcbiAgICAgIGNvbnN0IHByb21pc2VzID0gZGF0YS5yZXF1ZXN0cy5tYXAoKHJlcXVlc3QpID0+IHtcbiAgICAgICAgcmV0dXJuIGhhbmRsZVJlcXVlc3QocmVxdWVzdC5tZXRob2QsIHJlcXVlc3QucGF0aCwgcmVxdWVzdC5ib2R5LCBvcHRpb25zKS50aGVuKChyZXNwb25zZSkgPT4ge1xuICAgICAgICAgIHJldHVybiBQYXJzZS5Qcm9taXNlLmFzKHtzdWNjZXNzOiByZXNwb25zZX0pO1xuICAgICAgICB9LCAoZXJyb3IpID0+IHtcbiAgICAgICAgICByZXR1cm4gUGFyc2UuUHJvbWlzZS5hcyh7ZXJyb3I6IHtjb2RlOiBlcnJvci5jb2RlLCBlcnJvcjogZXJyb3IubWVzc2FnZX19KTtcbiAgICAgICAgfSk7XG4gICAgICB9KTtcbiAgICAgIHJldHVybiBQYXJzZS5Qcm9taXNlLmFsbChwcm9taXNlcyk7XG4gICAgfVxuXG4gICAgbGV0IHF1ZXJ5O1xuICAgIGlmIChtZXRob2QgPT09ICdHRVQnKSB7XG4gICAgICBxdWVyeSA9IGRhdGE7XG4gICAgfVxuXG4gICAgcmV0dXJuIG5ldyBQYXJzZS5Qcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIGdldEF1dGgob3B0aW9ucywgY29uZmlnKS50aGVuKChhdXRoKSA9PiB7XG4gICAgICAgIGNvbnN0IHJlcXVlc3QgPSB7XG4gICAgICAgICAgYm9keTogZGF0YSxcbiAgICAgICAgICBjb25maWcsXG4gICAgICAgICAgYXV0aCxcbiAgICAgICAgICBpbmZvOiB7XG4gICAgICAgICAgICBhcHBsaWNhdGlvbklkOiBhcHBsaWNhdGlvbklkLFxuICAgICAgICAgICAgc2Vzc2lvblRva2VuOiBvcHRpb25zLnNlc3Npb25Ub2tlblxuICAgICAgICAgIH0sXG4gICAgICAgICAgcXVlcnlcbiAgICAgICAgfTtcbiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpLnRoZW4oKCkgPT4ge1xuICAgICAgICAgIHJldHVybiByb3V0ZXIudHJ5Um91dGVSZXF1ZXN0KG1ldGhvZCwgcGF0aCwgcmVxdWVzdCk7XG4gICAgICAgIH0pLnRoZW4oKHJlc3BvbnNlKSA9PiB7XG4gICAgICAgICAgcmVzb2x2ZShyZXNwb25zZS5yZXNwb25zZSwgcmVzcG9uc2Uuc3RhdHVzLCByZXNwb25zZSk7XG4gICAgICAgIH0sIChlcnIpID0+IHtcbiAgICAgICAgICBpZiAoZXJyIGluc3RhbmNlb2YgUGFyc2UuRXJyb3IgJiZcbiAgICAgICAgICAgICAgZXJyLmNvZGUgPT0gUGFyc2UuRXJyb3IuSU5WQUxJRF9KU09OICYmXG4gICAgICAgICAgICAgIGVyci5tZXNzYWdlID09IGBjYW5ub3Qgcm91dGUgJHttZXRob2R9ICR7cGF0aH1gKSB7XG4gICAgICAgICAgICBSRVNUQ29udHJvbGxlci5yZXF1ZXN0LmFwcGx5KG51bGwsIGFyZ3MpLnRoZW4ocmVzb2x2ZSwgcmVqZWN0KTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVqZWN0KGVycik7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH0sIHJlamVjdCk7XG4gICAgfSk7XG4gIH1cblxuICByZXR1cm4gIHtcbiAgICByZXF1ZXN0OiBoYW5kbGVSZXF1ZXN0LFxuICAgIGFqYXg6IFJFU1RDb250cm9sbGVyLmFqYXhcbiAgfTtcbn1cblxuZXhwb3J0IGRlZmF1bHQgUGFyc2VTZXJ2ZXJSRVNUQ29udHJvbGxlcjtcbmV4cG9ydCB7IFBhcnNlU2VydmVyUkVTVENvbnRyb2xsZXIgfTtcbiJdfQ==