'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.PushWorker = undefined;

var _deepcopy = require('deepcopy');

var _deepcopy2 = _interopRequireDefault(_deepcopy);

var _AdaptableController = require('../Controllers/AdaptableController');

var _AdaptableController2 = _interopRequireDefault(_AdaptableController);

var _Auth = require('../Auth');

var _Config = require('../Config');

var _Config2 = _interopRequireDefault(_Config);

var _PushAdapter = require('../Adapters/Push/PushAdapter');

var _rest = require('../rest');

var _rest2 = _interopRequireDefault(_rest);

var _StatusHandler = require('../StatusHandler');

var _utils = require('./utils');

var utils = _interopRequireWildcard(_utils);

var _ParseMessageQueue = require('../ParseMessageQueue');

var _PushQueue = require('./PushQueue');

var _logger = require('../logger');

var _logger2 = _interopRequireDefault(_logger);

function _interopRequireWildcard(obj) { if (obj && obj.__esModule) { return obj; } else { var newObj = {}; if (obj != null) { for (var key in obj) { if (Object.prototype.hasOwnProperty.call(obj, key)) newObj[key] = obj[key]; } } newObj.default = obj; return newObj; } }

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function groupByBadge(installations) {
  return installations.reduce((map, installation) => {
    const badge = installation.badge + '';
    map[badge] = map[badge] || [];
    map[badge].push(installation);
    return map;
  }, {});
}
// -disable-next
class PushWorker {

  constructor(pushAdapter, subscriberConfig = {}) {
    _AdaptableController2.default.validateAdapter(pushAdapter, this, _PushAdapter.PushAdapter);
    this.adapter = pushAdapter;

    this.channel = subscriberConfig.channel || _PushQueue.PushQueue.defaultPushChannel();
    this.subscriber = _ParseMessageQueue.ParseMessageQueue.createSubscriber(subscriberConfig);
    if (this.subscriber) {
      const subscriber = this.subscriber;
      subscriber.subscribe(this.channel);
      subscriber.on('message', (channel, messageStr) => {
        const workItem = JSON.parse(messageStr);
        this.run(workItem);
      });
    }
  }

  run({ body, query, pushStatus, applicationId, UTCOffset }) {
    const config = _Config2.default.get(applicationId);
    const auth = (0, _Auth.master)(config);
    const where = utils.applyDeviceTokenExists(query.where);
    delete query.where;
    pushStatus = (0, _StatusHandler.pushStatusHandler)(config, pushStatus.objectId);
    return _rest2.default.find(config, auth, '_Installation', where, query).then(({ results }) => {
      if (results.length == 0) {
        return;
      }
      return this.sendToAdapter(body, results, pushStatus, config, UTCOffset);
    });
  }

  sendToAdapter(body, installations, pushStatus, config, UTCOffset) {
    // Check if we have locales in the push body
    const locales = utils.getLocalesFromPush(body);
    if (locales.length > 0) {
      // Get all tranformed bodies for each locale
      const bodiesPerLocales = utils.bodiesPerLocales(body, locales);

      // Group installations on the specified locales (en, fr, default etc...)
      const grouppedInstallations = utils.groupByLocaleIdentifier(installations, locales);
      const promises = Object.keys(grouppedInstallations).map(locale => {
        const installations = grouppedInstallations[locale];
        const body = bodiesPerLocales[locale];
        return this.sendToAdapter(body, installations, pushStatus, config, UTCOffset);
      });
      return Promise.all(promises);
    }

    if (!utils.isPushIncrementing(body)) {
      _logger2.default.verbose(`Sending push to ${installations.length}`);
      return this.adapter.send(body, installations, pushStatus.objectId).then(results => {
        return pushStatus.trackSent(results, UTCOffset).then(() => results);
      });
    }

    // Collect the badges to reduce the # of calls
    const badgeInstallationsMap = groupByBadge(installations);

    // Map the on the badges count and return the send result
    const promises = Object.keys(badgeInstallationsMap).map(badge => {
      const payload = (0, _deepcopy2.default)(body);
      payload.data.badge = parseInt(badge);
      const installations = badgeInstallationsMap[badge];
      return this.sendToAdapter(payload, installations, pushStatus, config, UTCOffset);
    });
    return Promise.all(promises);
  }
}

exports.PushWorker = PushWorker;
exports.default = PushWorker;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9QdXNoL1B1c2hXb3JrZXIuanMiXSwibmFtZXMiOlsidXRpbHMiLCJncm91cEJ5QmFkZ2UiLCJpbnN0YWxsYXRpb25zIiwicmVkdWNlIiwibWFwIiwiaW5zdGFsbGF0aW9uIiwiYmFkZ2UiLCJwdXNoIiwiUHVzaFdvcmtlciIsImNvbnN0cnVjdG9yIiwicHVzaEFkYXB0ZXIiLCJzdWJzY3JpYmVyQ29uZmlnIiwiQWRhcHRhYmxlQ29udHJvbGxlciIsInZhbGlkYXRlQWRhcHRlciIsIlB1c2hBZGFwdGVyIiwiYWRhcHRlciIsImNoYW5uZWwiLCJQdXNoUXVldWUiLCJkZWZhdWx0UHVzaENoYW5uZWwiLCJzdWJzY3JpYmVyIiwiUGFyc2VNZXNzYWdlUXVldWUiLCJjcmVhdGVTdWJzY3JpYmVyIiwic3Vic2NyaWJlIiwib24iLCJtZXNzYWdlU3RyIiwid29ya0l0ZW0iLCJKU09OIiwicGFyc2UiLCJydW4iLCJib2R5IiwicXVlcnkiLCJwdXNoU3RhdHVzIiwiYXBwbGljYXRpb25JZCIsIlVUQ09mZnNldCIsImNvbmZpZyIsIkNvbmZpZyIsImdldCIsImF1dGgiLCJ3aGVyZSIsImFwcGx5RGV2aWNlVG9rZW5FeGlzdHMiLCJvYmplY3RJZCIsInJlc3QiLCJmaW5kIiwidGhlbiIsInJlc3VsdHMiLCJsZW5ndGgiLCJzZW5kVG9BZGFwdGVyIiwibG9jYWxlcyIsImdldExvY2FsZXNGcm9tUHVzaCIsImJvZGllc1BlckxvY2FsZXMiLCJncm91cHBlZEluc3RhbGxhdGlvbnMiLCJncm91cEJ5TG9jYWxlSWRlbnRpZmllciIsInByb21pc2VzIiwiT2JqZWN0Iiwia2V5cyIsImxvY2FsZSIsIlByb21pc2UiLCJhbGwiLCJpc1B1c2hJbmNyZW1lbnRpbmciLCJsb2dnZXIiLCJ2ZXJib3NlIiwic2VuZCIsInRyYWNrU2VudCIsImJhZGdlSW5zdGFsbGF0aW9uc01hcCIsInBheWxvYWQiLCJkYXRhIiwicGFyc2VJbnQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7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LENBQW1Ca0IsT0FBbkIsRUFBNEI5RCxhQUE1QixFQUEyQzZCLFVBQTNDLEVBQXVERyxNQUF2RCxFQUErREQsU0FBL0QsQ0FBUDtBQUNELEtBTGdCLENBQWpCO0FBTUEsV0FBT3VCLFFBQVFDLEdBQVIsQ0FBWUwsUUFBWixDQUFQO0FBQ0Q7QUF0RXFCOztRQUFYNUMsVSxHQUFBQSxVO2tCQXlFRUEsVSIsImZpbGUiOiJQdXNoV29ya2VyLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQGZsb3dcbi8vIEBmbG93LWRpc2FibGUtbmV4dFxuaW1wb3J0IGRlZXBjb3B5ICAgICAgICAgICAgICAgZnJvbSAnZGVlcGNvcHknO1xuaW1wb3J0IEFkYXB0YWJsZUNvbnRyb2xsZXIgICAgZnJvbSAnLi4vQ29udHJvbGxlcnMvQWRhcHRhYmxlQ29udHJvbGxlcic7XG5pbXBvcnQgeyBtYXN0ZXIgfSAgICAgICAgICAgICBmcm9tICcuLi9BdXRoJztcbmltcG9ydCBDb25maWcgICAgICAgICAgICAgICAgIGZyb20gJy4uL0NvbmZpZyc7XG5pbXBvcnQgeyBQdXNoQWRhcHRlciB9ICAgICAgICBmcm9tICcuLi9BZGFwdGVycy9QdXNoL1B1c2hBZGFwdGVyJztcbmltcG9ydCByZXN0ICAgICAgICAgICAgICAgICAgIGZyb20gJy4uL3Jlc3QnO1xuaW1wb3J0IHsgcHVzaFN0YXR1c0hhbmRsZXIgfSAgZnJvbSAnLi4vU3RhdHVzSGFuZGxlcic7XG5pbXBvcnQgKiBhcyB1dGlscyAgICAgICAgICAgICBmcm9tICcuL3V0aWxzJztcbmltcG9ydCB7IFBhcnNlTWVzc2FnZVF1ZXVlIH0gIGZyb20gJy4uL1BhcnNlTWVzc2FnZVF1ZXVlJztcbmltcG9ydCB7IFB1c2hRdWV1ZSB9ICAgICAgICAgIGZyb20gJy4vUHVzaFF1ZXVlJztcbmltcG9ydCBsb2dnZXIgICAgICAgICAgICAgICAgIGZyb20gJy4uL2xvZ2dlcic7XG5cbmZ1bmN0aW9uIGdyb3VwQnlCYWRnZShpbnN0YWxsYXRpb25zKSB7XG4gIHJldHVybiBpbnN0YWxsYXRpb25zLnJlZHVjZSgobWFwLCBpbnN0YWxsYXRpb24pID0+IHtcbiAgICBjb25zdCBiYWRnZSA9IGluc3RhbGxhdGlvbi5iYWRnZSArICcnO1xuICAgIG1hcFtiYWRnZV0gPSBtYXBbYmFkZ2VdIHx8IFtdO1xuICAgIG1hcFtiYWRnZV0ucHVzaChpbnN0YWxsYXRpb24pO1xuICAgIHJldHVybiBtYXA7XG4gIH0sIHt9KTtcbn1cblxuZXhwb3J0IGNsYXNzIFB1c2hXb3JrZXIge1xuICBzdWJzY3JpYmVyOiA/YW55O1xuICBhZGFwdGVyOiBhbnk7XG4gIGNoYW5uZWw6IHN0cmluZztcblxuICBjb25zdHJ1Y3RvcihwdXNoQWRhcHRlcjogUHVzaEFkYXB0ZXIsIHN1YnNjcmliZXJDb25maWc6IGFueSA9IHt9KSB7XG4gICAgQWRhcHRhYmxlQ29udHJvbGxlci52YWxpZGF0ZUFkYXB0ZXIocHVzaEFkYXB0ZXIsIHRoaXMsIFB1c2hBZGFwdGVyKTtcbiAgICB0aGlzLmFkYXB0ZXIgPSBwdXNoQWRhcHRlcjtcblxuICAgIHRoaXMuY2hhbm5lbCA9IHN1YnNjcmliZXJDb25maWcuY2hhbm5lbCB8fCBQdXNoUXVldWUuZGVmYXVsdFB1c2hDaGFubmVsKCk7XG4gICAgdGhpcy5zdWJzY3JpYmVyID0gUGFyc2VNZXNzYWdlUXVldWUuY3JlYXRlU3Vic2NyaWJlcihzdWJzY3JpYmVyQ29uZmlnKTtcbiAgICBpZiAodGhpcy5zdWJzY3JpYmVyKSB7XG4gICAgICBjb25zdCBzdWJzY3JpYmVyID0gdGhpcy5zdWJzY3JpYmVyO1xuICAgICAgc3Vic2NyaWJlci5zdWJzY3JpYmUodGhpcy5jaGFubmVsKTtcbiAgICAgIHN1YnNjcmliZXIub24oJ21lc3NhZ2UnLCAoY2hhbm5lbCwgbWVzc2FnZVN0cikgPT4ge1xuICAgICAgICBjb25zdCB3b3JrSXRlbSA9IEpTT04ucGFyc2UobWVzc2FnZVN0cik7XG4gICAgICAgIHRoaXMucnVuKHdvcmtJdGVtKTtcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxuXG4gIHJ1bih7IGJvZHksIHF1ZXJ5LCBwdXNoU3RhdHVzLCBhcHBsaWNhdGlvbklkLCBVVENPZmZzZXQgfTogYW55KTogUHJvbWlzZTwqPiB7XG4gICAgY29uc3QgY29uZmlnID0gQ29uZmlnLmdldChhcHBsaWNhdGlvbklkKTtcbiAgICBjb25zdCBhdXRoID0gbWFzdGVyKGNvbmZpZyk7XG4gICAgY29uc3Qgd2hlcmUgPSB1dGlscy5hcHBseURldmljZVRva2VuRXhpc3RzKHF1ZXJ5LndoZXJlKTtcbiAgICBkZWxldGUgcXVlcnkud2hlcmU7XG4gICAgcHVzaFN0YXR1cyA9IHB1c2hTdGF0dXNIYW5kbGVyKGNvbmZpZywgcHVzaFN0YXR1cy5vYmplY3RJZCk7XG4gICAgcmV0dXJuIHJlc3QuZmluZChjb25maWcsIGF1dGgsICdfSW5zdGFsbGF0aW9uJywgd2hlcmUsIHF1ZXJ5KS50aGVuKCh7cmVzdWx0c30pID0+IHtcbiAgICAgIGlmIChyZXN1bHRzLmxlbmd0aCA9PSAwKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICAgIHJldHVybiB0aGlzLnNlbmRUb0FkYXB0ZXIoYm9keSwgcmVzdWx0cywgcHVzaFN0YXR1cywgY29uZmlnLCBVVENPZmZzZXQpO1xuICAgIH0pO1xuICB9XG5cbiAgc2VuZFRvQWRhcHRlcihib2R5OiBhbnksIGluc3RhbGxhdGlvbnM6IGFueVtdLCBwdXNoU3RhdHVzOiBhbnksIGNvbmZpZzogQ29uZmlnLCBVVENPZmZzZXQ6ID9hbnkpOiBQcm9taXNlPCo+IHtcbiAgICAvLyBDaGVjayBpZiB3ZSBoYXZlIGxvY2FsZXMgaW4gdGhlIHB1c2ggYm9keVxuICAgIGNvbnN0IGxvY2FsZXMgPSB1dGlscy5nZXRMb2NhbGVzRnJvbVB1c2goYm9keSk7XG4gICAgaWYgKGxvY2FsZXMubGVuZ3RoID4gMCkge1xuICAgICAgLy8gR2V0IGFsbCB0cmFuZm9ybWVkIGJvZGllcyBmb3IgZWFjaCBsb2NhbGVcbiAgICAgIGNvbnN0IGJvZGllc1BlckxvY2FsZXMgPSB1dGlscy5ib2RpZXNQZXJMb2NhbGVzKGJvZHksIGxvY2FsZXMpO1xuXG4gICAgICAvLyBHcm91cCBpbnN0YWxsYXRpb25zIG9uIHRoZSBzcGVjaWZpZWQgbG9jYWxlcyAoZW4sIGZyLCBkZWZhdWx0IGV0Yy4uLilcbiAgICAgIGNvbnN0IGdyb3VwcGVkSW5zdGFsbGF0aW9ucyA9IHV0aWxzLmdyb3VwQnlMb2NhbGVJZGVudGlmaWVyKGluc3RhbGxhdGlvbnMsIGxvY2FsZXMpO1xuICAgICAgY29uc3QgcHJvbWlzZXMgPSBPYmplY3Qua2V5cyhncm91cHBlZEluc3RhbGxhdGlvbnMpLm1hcCgobG9jYWxlKSA9PiB7XG4gICAgICAgIGNvbnN0IGluc3RhbGxhdGlvbnMgPSBncm91cHBlZEluc3RhbGxhdGlvbnNbbG9jYWxlXTtcbiAgICAgICAgY29uc3QgYm9keSA9IGJvZGllc1BlckxvY2FsZXNbbG9jYWxlXTtcbiAgICAgICAgcmV0dXJuIHRoaXMuc2VuZFRvQWRhcHRlcihib2R5LCBpbnN0YWxsYXRpb25zLCBwdXNoU3RhdHVzLCBjb25maWcsIFVUQ09mZnNldCk7XG4gICAgICB9KTtcbiAgICAgIHJldHVybiBQcm9taXNlLmFsbChwcm9taXNlcyk7XG4gICAgfVxuXG4gICAgaWYgKCF1dGlscy5pc1B1c2hJbmNyZW1lbnRpbmcoYm9keSkpIHtcbiAgICAgIGxvZ2dlci52ZXJib3NlKGBTZW5kaW5nIHB1c2ggdG8gJHtpbnN0YWxsYXRpb25zLmxlbmd0aH1gKTtcbiAgICAgIHJldHVybiB0aGlzLmFkYXB0ZXIuc2VuZChib2R5LCBpbnN0YWxsYXRpb25zLCBwdXNoU3RhdHVzLm9iamVjdElkKS50aGVuKChyZXN1bHRzKSA9PiB7XG4gICAgICAgIHJldHVybiBwdXNoU3RhdHVzLnRyYWNrU2VudChyZXN1bHRzLCBVVENPZmZzZXQpLnRoZW4oKCkgPT4gcmVzdWx0cyk7XG4gICAgICB9KTtcbiAgICB9XG5cbiAgICAvLyBDb2xsZWN0IHRoZSBiYWRnZXMgdG8gcmVkdWNlIHRoZSAjIG9mIGNhbGxzXG4gICAgY29uc3QgYmFkZ2VJbnN0YWxsYXRpb25zTWFwID0gZ3JvdXBCeUJhZGdlKGluc3RhbGxhdGlvbnMpO1xuXG4gICAgLy8gTWFwIHRoZSBvbiB0aGUgYmFkZ2VzIGNvdW50IGFuZCByZXR1cm4gdGhlIHNlbmQgcmVzdWx0XG4gICAgY29uc3QgcHJvbWlzZXMgPSBPYmplY3Qua2V5cyhiYWRnZUluc3RhbGxhdGlvbnNNYXApLm1hcCgoYmFkZ2UpID0+IHtcbiAgICAgIGNvbnN0IHBheWxvYWQgPSBkZWVwY29weShib2R5KTtcbiAgICAgIHBheWxvYWQuZGF0YS5iYWRnZSA9IHBhcnNlSW50KGJhZGdlKTtcbiAgICAgIGNvbnN0IGluc3RhbGxhdGlvbnMgPSBiYWRnZUluc3RhbGxhdGlvbnNNYXBbYmFkZ2VdO1xuICAgICAgcmV0dXJuIHRoaXMuc2VuZFRvQWRhcHRlcihwYXlsb2FkLCBpbnN0YWxsYXRpb25zLCBwdXNoU3RhdHVzLCBjb25maWcsIFVUQ09mZnNldCk7XG4gICAgfSk7XG4gICAgcmV0dXJuIFByb21pc2UuYWxsKHByb21pc2VzKTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBQdXNoV29ya2VyO1xuIl19